# インタラクティブモード

**バージョン:** 2.0
**最終更新:** 2026-01-30

---

## 概要

インタラクティブモードでは、マネージャーエージェントとリアルタイムで対話しながらタスクを進めることができます。

multi-agent-shogunにインスパイアされた機能で、ユーザー ⇄ マネージャー ⇄ ワーカーの3層構造で柔軟なタスク実行が可能です。

---

## 起動方法

```bash
# タスク説明を渡すだけで自動的にインタラクティブモード（CTO対話）が起動
mao start "認証システムを実装"
```

---

## ダッシュボードレイアウト

```
┌────────────────────────────────────────────────────────┐
│ MAO - Multi-Agent Orchestrator                        │
│ Task: 認証システムを実装                                 │
├──────────────────────────┬─────────────────────────────┤
│ [Agents]                 │ [Manager Chat]              │
│                          │                             │
│ ✓ manager    Completed   │ [18:30] You: タスクを計画し  │
│ ⚙ worker-1   Running     │ てください                   │
│ ⏸ worker-2   Waiting     │                             │
│                          │ [18:31] Manager: 了解です。  │
│                          │ 以下の3つのサブタスクに分解   │
├──────────────────────────┤ します...                   │
│ [Log]                    │                             │
│                          │                             │
│ 18:30:45 | INFO  | ...  │ ┌─────────────────────────┐ │
│ 18:30:46 | DEBUG | ...  │ │ メッセージを入力... ⏎   │ │
│                          │ └─────────────────────────┘ │
└──────────────────────────┴─────────────────────────────┘
 q:Quit r:Refresh ↑↓:Agent Ctrl+M:Focus Manager
```

### レイアウト構成

- **左パネル (60%)**
  - 上: エージェント一覧（30%）
  - 下: ログビューア（70%）- リアルタイムログ表示
    - マネージャーの実行ログ
    - ワーカーの実行ログ
    - ツール使用ログ
    - エラーログ

- **右パネル (40%)**
  - 上: マネージャーチャット履歴（90%）
  - 下: メッセージ入力フィールド（10%）

---

## ログビューア

### リアルタイムログ表示

左下のログビューアには、マネージャーとワーカーの実行ログがリアルタイムで表示されます。

#### ログレベル

| レベル | 色 | 説明 |
|--------|-----|------|
| INFO | シアン | 一般的な情報 |
| DEBUG | グレー | デバッグ情報 |
| WARN | 黄色 | 警告 |
| ERROR | 赤 | エラー |
| TOOL | マゼンタ | ツール使用 |
| THINKING | 青 | 思考プロセス |
| ACTION | 緑 | アクション実行 |
| RESULT | 明るい緑 | 実行結果 |

#### ログのフィルタリング

- `↑` / `↓` キーでエージェントを選択すると、そのエージェントのログのみ表示
- デフォルトは全エージェントのログを表示

#### 自動スクロール

新しいログが追加されると、自動的に最下部にスクロールします。

---

## 使い方

### 1. マネージャーとの対話

#### タスクの計画を依頼
```
You: 認証システムのタスクを3つのサブタスクに分解してください

Manager: 了解しました。以下の3つのサブタスクに分解します：
1. ログイン機能の実装
2. パスワードリセット機能の実装
3. ユニットテストの作成

それぞれworker-1, worker-2, worker-3に割り当てることを推奨します。
```

#### 質問する
```
You: どの認証方式を使うべきですか？

Manager: プロジェクトの要件を確認したところ、
JWT（JSON Web Token）認証を推奨します。理由は...
```

#### タスクの追加
```
You: パスワード強度チェックも追加してください

Manager: 了解しました。worker-4に
パスワード強度バリデーション機能を割り当てます。
```

### 2. キーボード操作

| キー | 機能 |
|------|------|
| `Ctrl+M` | マネージャーチャットにフォーカス |
| `Enter` | メッセージ送信 |
| `Esc` | フォーカスを外す |
| `↑` / `↓` | エージェント選択 |
| `q` | 終了 |
| `r` | 画面更新 |

### 3. ワークフロー

```
1. タスク開始
   ↓
2. マネージャーに計画を依頼
   ↓
3. マネージャーがサブタスクを提案
   ↓
4. 承認・修正を指示
   ↓
5. ワーカーへタスク分配（自動/手動）
   ↓
6. 進捗確認・追加指示
   ↓
7. 完了確認
```

---

## 実装詳細

### マネージャーチャットウィジェット

**ファイル:** `mao/ui/widgets/manager_chat.py`

**クラス:**
- `ChatMessage` - チャットメッセージモデル
- `ManagerChatWidget` - チャット履歴表示
- `ManagerChatInput` - メッセージ入力フィールド
- `ManagerChatPanel` - チャット全体のコンテナ

**主要機能:**
```python
# メッセージ追加
chat_panel.add_user_message("質問内容")
chat_panel.add_manager_message("回答内容")
chat_panel.add_system_message("システム通知")

# コールバック設定
chat_panel.set_send_callback(on_message_send)
```

### インタラクティブダッシュボード

**ファイル:** `mao/ui/dashboard_interactive.py`

**機能:**
- マネージャーとの非同期通信
- Claude Code CLI経由でマネージャーエージェント実行
- リアルタイム応答表示

**非同期処理:**
```python
async def send_to_manager(self, message: str):
    """マネージャーにメッセージを送信して応答を取得"""

    # リアルタイムログコールバック
    def on_log(log_line: str):
        if self.log_viewer_widget and log_line.strip():
            self.log_viewer_widget.add_log(
                log_line,
                level="INFO",
                agent_id="manager",
            )

    result = await self.manager_executor.execute_agent(
        prompt=f"タスク: {message}",
        model=self.initial_model,
        log_callback=on_log,  # リアルタイムログ
    )

    if result.get("success"):
        response = result.get("response")
        self.manager_chat_panel.add_manager_message(response)
```

---

## マネージャーエージェントの役割

マネージャーエージェントは以下の責任を持ちます：

1. **タスクの分析**
   - ユーザーのタスクを理解
   - 要件の明確化
   - 技術的な制約の確認

2. **計画の立案**
   - サブタスクへの分解
   - 優先順位付け
   - ワーカーへの割り当て提案

3. **質問への回答**
   - 技術的な相談
   - アーキテクチャの提案
   - ベストプラクティスの推奨

4. **進捗管理**
   - ワーカーの状態確認
   - ブロッカーの解消
   - 完了報告

---

## 設定

### マネージャーエージェントのモデル

デフォルトでは、起動時に指定したモデルを使用します：

```bash
# Sonnet（デフォルト、バランス型）
mao start "タスク"

# Opus（高性能、複雑なタスク向け）
mao start --model opus "複雑なタスク"

# Haiku（高速、シンプルなタスク向け）
mao start --model haiku "簡単なタスク"
```

### システムプロンプトのカスタマイズ

将来的には、マネージャーエージェントのシステムプロンプトをカスタマイズ可能にする予定：

```yaml
# .mao/config.yaml
manager:
  system_prompt: |
    あなたは経験豊富なプロジェクトマネージャーです。
    ユーザーのタスクを分析し、最適な計画を立ててください。
```

---

## 機能: CTOインタラクティブモード

| 項目 | 内容 |
|------|------|
| 起動 | `mao start "タスク説明"` |
| CTO（マネージャー） | あり（対話可能、タスク分解・ワーカー管理） |
| タスク分配 | CTOが適切なMAOロールに自動割り当て |
| ワーカー承認 | CTOが各ワーカーの完了を承認/却下 |
| 柔軟性 | 高（リアルタイムでCTOと対話） |
| 用途 | すべてのタスク（CTOが適切に管理） |

---

## トラブルシューティング

### マネージャーが応答しない

**原因:** Claude Code CLIの問題

**解決策:**
```bash
# Claude CLIの動作確認
echo "Hello" | claude --print --model sonnet

# APIキーの確認
echo $ANTHROPIC_API_KEY
```

### メッセージが送信できない

**原因:** 入力フィールドにフォーカスがない

**解決策:** `Ctrl+M`キーを押してフォーカス

### 応答が遅い

**原因:** ネットワーク遅延、またはモデルの処理時間

**対策:**
- Haikuモデルを使用（`--model haiku`）
- インターネット接続を確認

---

## ベストプラクティス

### 1. 明確な指示を出す

❌ **悪い例:**
```
You: これやって
```

✅ **良い例:**
```
You: ログイン機能を実装してください。
要件:
- Email/パスワード認証
- JWT トークン発行
- セッション管理
```

### 2. 段階的に進める

```
Step 1: 計画の確認
You: まず全体の計画を教えてください

Step 2: サブタスクの詳細
You: タスク1の実装方法を詳しく教えてください

Step 3: 実行確認
You: では worker-1 にタスク1を割り当ててください
```

### 3. 定期的に進捗確認

```
You: 現在の進捗状況を教えてください
You: ブロッカーはありますか？
You: 次に何をすべきですか？
```

---

## 今後の拡張

### Phase 1（実装済み）
- [x] マネージャーチャットUI
- [x] 基本的な対話機能
- [x] Claude Code CLI統合

### Phase 2（予定）
- [ ] ワーカーへの自動タスク分配
- [ ] タスクステータスの自動更新
- [ ] マネージャーからの能動的な提案

### Phase 3（予定）
- [ ] YAMLベースのタスクキュー
- [ ] マネージャー ⇄ ワーカー間通信
- [ ] 複数マネージャーのサポート

---

## クイックリファレンス

### 起動コマンド

```bash
mao start "Task description"
# CTO interactive mode is automatically enabled
```

### キーボードショートカット（まとめ）

| キー | アクション |
|-----|--------|
| `Ctrl+M` | マネージャーチャットにフォーカス |
| `Enter` | メッセージ送信 |
| `Esc` | フォーカス解除 |
| `↑` / `↓` | エージェント選択 |
| `q` | 終了 |
| `r` | 画面更新 |

### チャットメッセージの種類

- 💬 **You** (シアン): あなたのメッセージ
- 🤖 **CTO** (緑): CTOの応答
- ℹ️ **System** (黄色): システム通知

### MAOロール（CTOが自動割り当て）

| ロール | 用途 |
|--------|------|
| coder_backend | バックエンド実装 |
| reviewer | コードレビュー |
| tester | テスト作成・実行 |
| planner | タスク計画・設計 |
| researcher | 技術調査 |
| auditor | セキュリティ監査 |

### よく使うコマンド例

```
# タスク計画を依頼
You: タスクを3つのサブタスクに分解してください

# 質問
You: どの認証方式を推奨しますか？

# 実装依頼
You: ログイン機能を実装してください

# 進捗確認
You: 現在の進捗を教えてください
```

---

## 参考資料

- [multi-agent-shogun](https://github.com/yohey-w/multi-agent-shogun) - インスピレーション元
- [DASHBOARD_SPECIFICATION.md](DASHBOARD_SPECIFICATION.md) - ダッシュボード設計書

---

**作成日:** 2026-01-30
**更新予定:** 機能追加時
