# MAO ワークフロー

**バージョン:** 1.0
**最終更新:** 2026-02-03

---

## 概要

MAOのワークフローは、CTOを中心とした対話型のタスク実行システムです。

## 基本ワークフロー

```
┌─────────────────────────────────────────────────────┐
│                    ユーザー                          │
│              mao start "タスク説明"                  │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌───────────────────────┴─────────────────────────────┐
│                      CTO                             │
│  1. タスクを分析                                      │
│  2. サブタスクに分解                                  │
│  3. 適切なワーカータイプを選択                        │
│  4. ワーカーを起動                                    │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌───────────────────────┴─────────────────────────────┐
│                   ワーカー                           │
│  - タスクを実行                                       │
│  - 結果を報告                                        │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌───────────────────────┴─────────────────────────────┐
│                    CTO承認                           │
│  - 結果を確認                                        │
│  - 承認 → 次のタスクへ                               │
│  - 却下 → 再実行または修正                           │
└─────────────────────────────────────────────────────┘
```

## ユーザーとCTOの対話

### 対話の種類

| 種類 | 説明 | 例 |
|------|------|-----|
| タスク依頼 | 実行したいタスクを伝える | "ログイン機能を実装して" |
| 質問 | 技術的な相談 | "どの認証方式がいい？" |
| 進捗確認 | 現在の状況を確認 | "進捗を教えて" |
| 追加指示 | 実行中に追加の指示 | "テストも追加して" |

### CTOの応答

CTOは以下の形式で応答します：

```
計画を提案:
1. サブタスク1の説明
2. サブタスク2の説明
3. ...

実行しますか？
```

## タスク実行フロー

### 1. タスク分解

CTOがタスクを分析し、実行可能なサブタスクに分解：

```
入力: "認証システムを実装して"

CTOの分解:
├── タスク1: ユーザーモデルの作成 (general-purpose)
├── タスク2: ログインAPIの実装 (general-purpose)
├── タスク3: JWTトークン生成 (general-purpose)
├── タスク4: テストの作成 (general-purpose)
└── タスク5: 動作確認 (Bash)
```

### 2. ワーカー起動

CTOが `/spawn-worker` スキルでワーカーを起動：

```yaml
task: "ユーザーモデルの作成"
role: "general-purpose"
model: "sonnet"
worktree_required: true
```

### 3. ワーカー実行

ワーカーがtmuxペイン内で実行：

```bash
# 実際の実行コマンド
cat prompt_file | claude --print --model sonnet --add-dir /path/to/worktree
```

### 4. 結果の承認

ワーカー完了後、結果が承認キューに追加：

```
[承認待ち]
ワーカー: worker-1
タスク: ユーザーモデルの作成
結果: 成功
変更ファイル:
  - src/models/user.py (new)
  - src/schemas/user.py (new)

[承認] [却下]
```

### 5. 次のタスクへ

承認されると、CTOが次のタスクを開始。

## 実行モード

### シーケンシャル実行（現在実装済み）

タスクを順番に1つずつ実行：

```
タスク1 → 完了 → タスク2 → 完了 → タスク3 → ...
```

### 並列実行（将来実装）

依存関係のないタスクを並列実行：

```
タスク1 ─┬─→ 完了 ─┐
タスク2 ─┤         ├─→ タスク4
タスク3 ─┴─→ 完了 ─┘
```

## ワーカータイプの選択

CTOは以下の基準でワーカータイプを選択：

| タスクの種類 | 推奨タイプ |
|-------------|-----------|
| コード実装 | general-purpose |
| ファイル検索・調査 | Explore |
| コマンド実行（テスト、ビルド） | Bash |
| 設計・計画 | Plan |

## 承認フロー

### 自動承認

以下の場合、CTOが自動承認：

- エラーなしで完了
- 期待通りの出力
- セキュリティ上の問題なし

### 手動確認

以下の場合、ユーザーに確認：

- 大規模な変更
- セキュリティに関わる変更
- 設定ファイルの変更

### 却下時の対応

却下された場合、CTOは：

1. 問題点を分析
2. 修正指示を作成
3. ワーカーを再起動

## エラーハンドリング

### ワーカーエラー

```
ワーカーエラー発生
    ↓
エラーログを確認
    ↓
┌─────────┴─────────┐
↓                   ↓
再試行可能         再試行不可
    ↓                   ↓
自動リトライ      ユーザーに報告
```

### タイムアウト

長時間実行されるタスクは自動的にタイムアウト：

- デフォルト: 10分
- 設定変更可能

## ベストプラクティス

### 1. 明確なタスク説明

```
❌ "これ直して"
✅ "login.pyのバリデーションエラーを修正して"
```

### 2. 段階的な依頼

```
✅ Step 1: "まず現在の認証フローを調査して"
✅ Step 2: "JWT認証に変更する計画を立てて"
✅ Step 3: "計画に従って実装して"
```

### 3. 定期的な進捗確認

```
"現在の進捗を教えて"
"ブロッカーはある？"
"次のステップは？"
```

## 関連ドキュメント

- [ARCHITECTURE.md](./ARCHITECTURE.md) - システムアーキテクチャ
- [INTERACTIVE_MODE.md](./INTERACTIVE_MODE.md) - インタラクティブモード
- [CTO_ARCHITECTURE.md](./CTO_ARCHITECTURE.md) - CTO詳細設計
