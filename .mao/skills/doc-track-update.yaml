name: doc-track-update
display_name: "ğŸ”„ Update Tracked Documents"
description: |
  ã‚¹ã‚­ãƒ«: è¿½è·¡ä¸­ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹

  å®Ÿè£…å†…å®¹ã«åŸºã¥ã„ã¦ã€è¿½è·¡ä¸­ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•çš„ã«æ›´æ–°ã—ã¾ã™ã€‚
  æœªæ›´æ–°ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’è¡¨ç¤ºã—ã€æ›´æ–°ãŒå¿…è¦ãªç®‡æ‰€ã‚’ææ¡ˆã—ã¾ã™ã€‚

  ä½¿ç”¨ä¾‹:
    /doc-track-update

category: documentation
version: "1.0.0"

parameters:
  - name: auto
    description: è‡ªå‹•çš„ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ï¼ˆç¢ºèªãªã—ï¼‰
    required: false
    default: "false"
    type: string
    choices:
      - "true"
      - "false"

script: |
  #!/usr/bin/env python3
  import sys
  import os
  from pathlib import Path

  # MAOãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  sys.path.insert(0, str(Path(__file__).parent.parent.parent))
  from mao.orchestrator.document_tracker import DocumentTracker

  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹
  project_path = Path(os.environ.get("PWD", "."))

  # ã‚»ãƒƒã‚·ãƒ§ãƒ³IDå–å¾—
  current_session = os.environ.get("MAO_SESSION_ID")
  if not current_session:
      print("âŒ ã‚¨ãƒ©ãƒ¼: MAOã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
      sys.exit(1)

  # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
  auto_mode = os.environ.get("AUTO", "false").lower() == "true"

  # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒˆãƒ©ãƒƒã‚«ãƒ¼åˆæœŸåŒ–
  tracker = DocumentTracker(project_path=project_path)

  # ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—
  session_info = tracker.get_session_info(current_session)
  if not session_info:
      print("âŒ ã‚¨ãƒ©ãƒ¼: è¿½è·¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
      tracker.close()
      sys.exit(1)

  # æœªæ›´æ–°ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—
  pending_docs = tracker.get_pending_updates(current_session)

  if not pending_docs:
      print("âœ… ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°æ¸ˆã¿ã§ã™")
      tracker.close()
      sys.exit(0)

  print("ğŸ“‹ æœªæ›´æ–°ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:")
  print("=" * 60)
  for i, doc in enumerate(pending_docs, 1):
      print(f"{i}. {doc['document_path']}")
      print(f"   ç†ç”±: {doc['reason']}")
      if doc['section']:
          print(f"   ã‚»ã‚¯ã‚·ãƒ§ãƒ³: {doc['section']}")
      if doc['line_start'] is not None or doc['line_end'] is not None:
          if doc['line_start'] is not None and doc['line_end'] is not None:
              print(f"   è¡Œç¯„å›²: {doc['line_start']}-{doc['line_end']}")
          elif doc['line_start'] is not None:
              print(f"   é–‹å§‹è¡Œ: {doc['line_start']}")
          elif doc['line_end'] is not None:
              print(f"   çµ‚äº†è¡Œ: {doc['line_end']}")
      print()

  print("ğŸ¤– æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
  print()
  print("ã“ã‚Œã‚‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å®Ÿè£…å†…å®¹ã«åŸºã¥ã„ã¦æ›´æ–°ã—ã¦ãã ã•ã„ã€‚")
  print()
  print("å„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦:")
  for doc in pending_docs:
      doc_path = Path(project_path) / doc['document_path']
      if doc_path.exists():
          print(f"ğŸ“„ {doc['document_path']}")
          print(f"   æ›´æ–°ç†ç”±: {doc['reason']}")
          if doc['section']:
              print(f"   å¯¾è±¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³: {doc['section']}")
          if doc['line_start'] is not None or doc['line_end'] is not None:
              if doc['line_start'] is not None and doc['line_end'] is not None:
                  print(f"   å¯¾è±¡è¡Œç¯„å›²: {doc['line_start']}-{doc['line_end']}")
                  print(f"   â†’ Readãƒ„ãƒ¼ãƒ«ã§ offset={doc['line_start']-1}, limit={doc['line_end']-doc['line_start']+1} ã‚’ä½¿ç”¨")
              elif doc['line_start'] is not None:
                  print(f"   å¯¾è±¡é–‹å§‹è¡Œ: {doc['line_start']}")
                  print(f"   â†’ Readãƒ„ãƒ¼ãƒ«ã§ offset={doc['line_start']-1} ã‚’ä½¿ç”¨")
              elif doc['line_end'] is not None:
                  print(f"   å¯¾è±¡çµ‚äº†è¡Œ: {doc['line_end']}")
          print(f"   â†’ Readã€Editã€Writeãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦æ›´æ–°ã—ã¦ãã ã•ã„")
          print()
      else:
          print(f"âš ï¸ {doc['document_path']} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
          print()

  print("ğŸ’¡ æ›´æ–°å®Œäº†å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§æ›´æ–°æ¸ˆã¿ã¨ãƒãƒ¼ã‚¯ã—ã¦ãã ã•ã„:")
  print()
  print("[DOC_UPDATE_COMPLETE]")
  print("{")
  for doc in pending_docs:
      print(f'  "{doc["document_path"]}": "æ›´æ–°å†…å®¹ã®ãƒ¡ãƒ¢",')
  print("}")
  print("[/DOC_UPDATE_COMPLETE]")

  tracker.close()

requires_approval: false
risk_level: medium

metadata:
  author: MAO System
  tags:
    - documentation
    - tracking
    - update
  examples:
    - description: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
      command: /doc-track-update

    - description: è‡ªå‹•æ›´æ–°ãƒ¢ãƒ¼ãƒ‰
      command: /doc-track-update --auto true
